

<!DOCTYPE html>
<html class="no-js" lang="en">
    
    

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width initial-scale=1" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>
             Speculative query execution | Scylla Docs 
        </title>
        <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server." />
        <link rel="icon" href="../../../_static/img/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="../../../_static/img/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" href="../../../_static/img/favicon-228x228.png" sizes="192x192" />
        <link rel="apple-touch-icon" href="../../../_static/img/favicon-228x228.png" />
        <meta name="msapplication-TileImage" href="../../../_static/img/favicon-228x228.png" />

        
            
        

        
            
            <link rel="canonical" href="https://java-driver.docs.scylladb.com/stable/manual/core/speculative_execution/"/>
        

        <link rel="author" href="mailto:info@scylladb.com" />

        
            
        <!-- increase expertrec loading priority-->
        <link rel="dns-prefetch" href="https://cse.expertrec.com">

        <!-- increase font loading priority -->
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="preload" as="style"
            href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap" />

        <!-- async CSS -->
        <link rel="stylesheet" media="print" onload="this.onload=null;this.removeAttribute('media');"
            href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap" />

        <!-- no-JS fallback -->
        <noscript>
            <link rel="stylesheet"
                href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap" />
        </noscript>
        
            
                <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
            
        
            
                <link rel="stylesheet" type="text/css" href="../../../_static/css/main.css" />
            
        
            
                <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_collapse.css" />
            
        
            
                <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
            
        
    
        
        
            

        <script type="text/javascript" id="documentation_options" data-url_root="../../../"
            src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/js/runtime.bundle.js"></script>
        <script type="text/javascript" src="../../../_static/js/main.bundle.js"></script>
        
            
                <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
            
        
            
        
            
                <script src="../../../_static/underscore.js"></script>
            
        
            
                <script src="../../../_static/doctools.js"></script>
            
        
            
                <script src="../../../_static/clipboard.min.js"></script>
            
        
            
                <script src="../../../_static/copybutton.js"></script>
            
        
    
            <!-- Google Tag Manager -->
<script>
    (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
            "gtm.start": new Date().getTime(),
            event: "gtm.js"
        });
        var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
    })(window, document, "script", "dataLayer", "GTM-T8P2JP");
</script>
<!-- End Google Tag Manager -->

<!-- Expertrec -->
<script>
    var id = "e2077224-9ccf-11e9-a0c9-0242ac130002";
    var ci_search = document.createElement("script");
    ci_search.type = "text/javascript";
    ci_search.async = true;
    ci_search.src = "https://cse.expertrec.com/api/js/ci_common.js?id=" + id;
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(ci_search, s);
</script>
<!-- End Expertrec -->
        
        <!-- Font Awesome -->
        <script src="https://kit.fontawesome.com/b1870adf6a.js" crossorigin="anonymous"></script>
        <!-- End Font Awesome -->
    </head>

    <body>
        
        <header class="header">
    <div class="header-logo">
        <a class="header-logo__img" href="https://scylladb.com/">
            <img src="../../../_static/img/logo-docs.svg" alt="Scylla Documentation Logo" />
        </a>
        <span class="header-logo__bar"></span>
        <a class="header-logo__text" href="https://docs.scylladb.com/">
            Documentation
        </a>
    </div>
    <div class="header-navigation">
        <ul class="dropdown menu scylla-dropdown scylla-dropdown--header" data-dropdown-menu>
            <li class="scylla-dropdown__item">
                <a href="#" class="scylla-dropdown__title">Server
                    <i class="chevron scylla-icon scylla-icon--triangle-down"></i></a>
                <ul class="menu scylla-dropdown__content">
                    <li>
                        <a href="https://docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--about-us"></i>
                            Scylla Open Source
                        </a>
                    </li>
                    <li>
                        <a href="https://docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--enterprise"></i>Scylla Enterprise
                        </a>
                    </li>
                    <li>
                        <a href="https://scylla.docs.scylladb.com/stable/alternator/alternator.html">
                            <i class="scylla-icon scylla-icon--overview"></i>
                            Scylla Alternator
                        </a>
                    </li>
                </ul>
            </li>
            <li class="scylla-dropdown__item">
                <a href="#" class="scylla-dropdown__title">Cloud <i
                    class="chevron scylla-icon scylla-icon--triangle-down"></i></a>
                <ul class="menu scylla-dropdown__content">
                    <li>
                        <a href="https://cloud.scylladb.com/">
                            <i class="scylla-icon scylla-icon--cloud"></i>Scylla Cloud</a>
                    </li>
                    <li>
                        <a href="https://docs.scylladb.com/scylla-cloud/">
                            <i class="scylla-icon scylla-icon--cloud-docs"></i>Scylla Cloud
                            Docs</a>
                    </li>
                </ul>
            </li>
            <li class="scylla-dropdown__item">
                <a href="#" class="scylla-dropdown__title">Tools <i
                    class="chevron scylla-icon scylla-icon--triangle-down"></i></a>
                <ul class="menu scylla-dropdown__content">
                    <li>
                        <a href="https://manager.docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--manager"></i>Scylla Manager</a>
                    </li>
                    <li>
                        <a href="https://monitoring.docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--monitoring"></i>Scylla
                            Monitoring Stack</a>
                    </li>
                    <li>
                        <a href="https://operator.docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--operator"></i>Scylla Operator
                        </a>
                    </li>
                </ul>
            </li>
            <li class="scylla-dropdown__item">
                <a href="#" class="scylla-dropdown__title">Drivers <i
                    class="chevron scylla-icon scylla-icon--triangle-down"></i></a>
                <ul class="menu scylla-dropdown__content">
                    <li>
                        <a href="https://docs.scylladb.com/using-scylla/drivers/cql-drivers/">
                            <i class="scylla-icon scylla-icon--nsql-guides"></i>CQL Drivers
                        </a>
                    </li>
                    <li>
                        <a href="https://docs.scylladb.com/using-scylla/drivers/dynamo-drivers/">
                            <i class="scylla-icon scylla-icon--overview"></i>DynamoDB Drivers
                        </a>
                    </li>
                </ul>
            </li>
        </ul>
        <div class="header-button">
            <a href="https://www.scylladb.com/download/" class="button">Download</a>
        </div>
    </div>
    <div class="header-search-box">
        <div class="search-box">
            <ci-search></ci-search>
        </div>
    </div>
    <div class="side-nav-toggle" data-toggle="side-nav">
    <div class="side-nav-toggle__button">
        <img src="../../../_static/img/menu.svg" alt="Menu" />
    </div>
</div>
</header>
        <section
            class="layout  layout--sidebar layout--has-secondary-sidebar ">
            <div class="content large-order-2">
                
                    
    <div class="admonition caution">
        <p class="admonition-title">Caution</p>
        <p>
            
                You're viewing documentation for a previous version of Scylla Java Driver.
            
            <a href="../../../../stable/index.html">Switch to the latest stable version.</a>
        </p>
    </div>

                
                
                    <div class="pre-content">
                        <div class="breadcrumbs">
    <span class="bread__item">
        <a href="https://java-driver.docs.scylladb.com"
            class="bread__highlight">
            <i class="fas fa-home"></i> Scylla Java Driver
        </a>
    </span>
    
        <span class="bread__item">
            <a href="../../index.html">
                Manual
            </a>
        </span>
    
        <span class="bread__item">
            <a href="../index.html">
                Core driver
            </a>
        </span>
    
    <span class="bread__item bread__item--last">Speculative query execution</span>
</div>
                    </div>
                
                <section id="speculative-query-execution">
<h1>Speculative query execution<a class="headerlink" href="#speculative-query-execution" title="Permalink to this headline">¶</a></h1>
<section id="quick-overview">
<h2>Quick overview<a class="headerlink" href="#quick-overview" title="Permalink to this headline">¶</a></h2>
<p>Pre-emptively query another node if the current one takes too long to respond.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">advanced.speculative-execution-policy</span></code> in the configuration.</p></li>
<li><p>disabled by default. Also available: constant delay, or write your own policy.</p></li>
<li><p>can have per-profile policies.</p></li>
<li><p>only kicks in if the query is idempotent.</p></li>
<li><p>creates more traffic: tune your pool and provision your cluster accordingly.</p></li>
</ul>
<hr class="docutils" />
<p>Sometimes a Cassandra node might be experiencing difficulties (ex: long GC pause) and take longer
than usual to reply. Queries sent to that node will experience bad latency.</p>
<p>One thing we can do to improve that is pre-emptively start a second execution of the query against
another node, before the first node has replied or errored out. If that second node replies faster,
we can send the response back to the client. We also cancel the first execution (note that
“cancelling” in this context simply means discarding the response when it arrives later, Cassandra
does not support cancellation of in flight requests):</p>
<div class="highlight-ditaa notranslate"><div class="highlight"><pre><span></span>client           driver          exec1  exec2
--+----------------+--------------+------+---
  <span class="p">|</span> execute<span class="o">(</span>query<span class="o">)</span> <span class="p">|</span>
  <span class="p">|</span>---------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> query node1
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     query node2
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     node2 replies   <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;--------------------<span class="p">|</span>
  <span class="p">|</span>   <span class="nb">complete</span>     <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>&lt;---------------<span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> cancel       <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
</pre></div>
</div>
<p>Or the first node could reply just after the second execution was started. In this case, we cancel
the second execution. In other words, whichever node replies faster “wins” and completes the client
query:</p>
<div class="highlight-ditaa notranslate"><div class="highlight"><pre><span></span>client           driver          exec1  exec2
--+----------------+--------------+------+---
  <span class="p">|</span> execute<span class="o">(</span>query<span class="o">)</span> <span class="p">|</span>
  <span class="p">|</span>---------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> query node1
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     query node2
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> node1 replies<span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;-------------<span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>   <span class="nb">complete</span>     <span class="p">|</span>                     <span class="p">|</span>
  <span class="p">|</span>&lt;---------------<span class="p">|</span>                     <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> cancel              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
</pre></div>
</div>
<p>Speculative executions are <strong>disabled</strong> by default. The following sections cover the practical
details and how to enable them.</p>
</section>
<section id="query-idempotence">
<h2>Query idempotence<a class="headerlink" href="#query-idempotence" title="Permalink to this headline">¶</a></h2>
<p>If a query is <a class="reference external" href="../idempotence/">not idempotent</a>, the driver will never schedule speculative
executions for it, because there is no way to guarantee that only one node will apply the mutation.</p>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Speculative executions are controlled by a policy defined in the <a class="reference external" href="../configuration/">configuration</a>.
The default implementation never schedules an execution:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>datastax-java-driver.advanced.speculative-execution-policy {
  class = NoSpeculativeExecutionPolicy
}
</pre></div>
</div>
<p>The “constant” policy schedules executions at a fixed delay:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>datastax-java-driver.advanced.speculative-execution-policy {
  class = ConstantSpeculativeExecutionPolicy
  
  # The maximum number of executions (including the initial, non-speculative execution).
  # This must be at least one.
  max-executions = 3

  # The delay between each execution. 0 is allowed, and will result in all executions being sent
  # simultaneously when the request starts.
  # Note that sub-millisecond precision is not supported, any excess precision information will
  # be dropped; in particular, delays of less than 1 millisecond are equivalent to 0.
  # This must be positive or 0.
  delay = 100 milliseconds
}
</pre></div>
</div>
<p>Given the above configuration, an idempotent query would be handled this way:</p>
<ul class="simple">
<li><p>start the initial execution at t0;</p></li>
<li><p>if no response has been received at t0 + 100 milliseconds, start a speculative execution on
another node;</p></li>
<li><p>if no response has been received at t0 + 200 milliseconds, start another speculative execution on
a third node;</p></li>
<li><p>past that point, don’t query other nodes, just wait for the first response to arrive.</p></li>
</ul>
<p>Finally, you can create your own policy by implementing <a class="reference external" href="https://java-driver.docs.scylladb.com/scylla-4.11.1.x/api/com/datastax/oss/driver/api/core/specex/SpeculativeExecutionPolicy.html">SpeculativeExecutionPolicy</a>, and
referencing your implementation class from the configuration.</p>
</section>
<section id="how-speculative-executions-affect-retries">
<h2>How speculative executions affect retries<a class="headerlink" href="#how-speculative-executions-affect-retries" title="Permalink to this headline">¶</a></h2>
<p>Turning on speculative executions doesn’t change the driver’s <a class="reference external" href="../retries/">retry</a> behavior. Each
parallel execution will trigger retries independently:</p>
<div class="highlight-ditaa notranslate"><div class="highlight"><pre><span></span>client           driver          exec1  exec2
--+----------------+--------------+------+---
  <span class="p">|</span> execute<span class="o">(</span>query<span class="o">)</span> <span class="p">|</span>
  <span class="p">|</span>---------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> query node1
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> unavailable  <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;-------------<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>retry at lower CL
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     query node2
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     server error    <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;--------------------<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>   retry on node3
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> node1 replies<span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;-------------<span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>   <span class="nb">complete</span>     <span class="p">|</span>                     <span class="p">|</span>
  <span class="p">|</span>&lt;---------------<span class="p">|</span>                     <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> cancel              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
</pre></div>
</div>
<p>The only impact is that all executions of the same query always share the same query plan, so each
node will be used by at most one execution.</p>
</section>
<section id="tuning-and-practical-details">
<h2>Tuning and practical details<a class="headerlink" href="#tuning-and-practical-details" title="Permalink to this headline">¶</a></h2>
<p>The goal of speculative executions is to improve overall latency (the time between <code class="docutils literal notranslate"><span class="pre">execute(query)</span></code>
and <code class="docutils literal notranslate"><span class="pre">complete</span></code> in the diagrams above) at high percentiles. On the flip side, too many speculative
executions increase the pressure on the cluster.</p>
<p>If you use speculative executions to avoid unhealthy nodes, a good-behaving node should rarely hit
the threshold. We recommend running a benchmark on a healthy platform (all nodes up and healthy) and
monitoring the request percentiles with the <code class="docutils literal notranslate"><span class="pre">cql-requests</span></code> <a class="reference external" href="../metrics/">metric</a>. Then use the
latency at a high percentile (for example p99.9) as the threshold.</p>
<p>Alternatively, maybe low latency is your absolute priority, and you are willing to take the
increased throughput as a tradeoff. In that case, set the threshold to 0 and provision your cluster
accordingly.</p>
<p>You can monitor the number of speculative executions triggered by each node with the
<code class="docutils literal notranslate"><span class="pre">speculative-executions</span></code> <a class="reference external" href="../metrics/">metric</a>.</p>
<section id="stream-id-exhaustion">
<h3>Stream id exhaustion<a class="headerlink" href="#stream-id-exhaustion" title="Permalink to this headline">¶</a></h3>
<p>One side-effect of speculative executions is that many requests get cancelled, which can lead to a
phenomenon called <em>stream id exhaustion</em>: each TCP connection can handle multiple simultaneous
requests, identified by a unique number called <em>stream id</em> (see also the <a class="reference external" href="../pooling/">pooling</a>
section). When a request gets cancelled, we can’t reuse its stream id immediately because we might
still receive a response from the server later. If this happens often, the number of available
stream ids diminishes over time, and when it goes below a given threshold we close the connection
and create a new one. If requests are often cancelled, you will see connections being recycled at a
high rate.</p>
<p>The best way to monitor this is to compare the <code class="docutils literal notranslate"><span class="pre">pool.orphaned-streams</span></code> <a class="reference external" href="../metrics/">metric</a> to the
total number of available stream ids (which can be computed from the configuration:
<code class="docutils literal notranslate"><span class="pre">pool.local.size</span> <span class="pre">*</span> <span class="pre">max-requests-per-connection</span></code>). The <code class="docutils literal notranslate"><span class="pre">pool.available-streams</span></code> and <code class="docutils literal notranslate"><span class="pre">pool.in-flight</span></code>
metrics will also give you an idea of how many stream ids are left for active queries.</p>
</section>
<section id="request-ordering">
<h3>Request ordering<a class="headerlink" href="#request-ordering" title="Permalink to this headline">¶</a></h3>
<p>Note: ordering issues are only a problem with <a class="reference external" href="../query_timestamps/">server-side timestamps</a>, which
are not the default anymore in driver 4+. So unless you’ve explicitly enabled
<code class="docutils literal notranslate"><span class="pre">ServerSideTimestampGenerator</span></code>, you can skip this section.</p>
<p>Suppose you run the following query with speculative executions and server-side timestamps enabled:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insert</span> <span class="n">into</span> <span class="n">my_table</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="n">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>The first execution is a bit too slow, so a second execution gets triggered. Finally, the first
execution completes, so the client code gets back an acknowledgement, and the second execution is
cancelled. However, cancelling only means that the driver stops waiting for the server’s response,
the request could still be “on the wire”; let’s assume that this is the case.</p>
<p>Now you run the following query, which completes successfully:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">delete</span> <span class="kn">from</span> <span class="nn">my_table</span> <span class="n">where</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>But now the second execution of the first query finally reaches its target node, which applies the
mutation. The row that you’ve just deleted is back!</p>
<p>The workaround is to either specify a timestamp in your CQL queries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insert</span> <span class="n">into</span> <span class="n">my_table</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="n">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">USING</span> <span class="n">TIMESTAMP</span> <span class="mi">1432764000</span><span class="p">;</span>
</pre></div>
</div>
<p>Or use a client-side <a class="reference external" href="../query_timestamps/">timestamp generator</a>.</p>
</section>
</section>
<section id="using-multiple-policies">
<h2>Using multiple policies<a class="headerlink" href="#using-multiple-policies" title="Permalink to this headline">¶</a></h2>
<p>The speculative execution policy can be overridden in <a class="reference external" href="../configuration/#profiles">execution
profiles</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>datastax-java-driver {
  advanced.speculative-execution-policy {
    class = ConstantSpeculativeExecutionPolicy
    max-executions = 3
    delay = 100 milliseconds
  }
  profiles {
    oltp {
      basic.request.timeout = 100 milliseconds
    }
    olap {
      basic.request.timeout = 30 seconds
      advanced.speculative-execution-policy.class = NoSpeculativeExecutionPolicy
    }
  }
}
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">olap</span></code> profile uses its own policy. The <code class="docutils literal notranslate"><span class="pre">oltp</span></code> profile inherits the default profile’s. Note that
this goes beyond configuration inheritance: the driver only creates a single
<code class="docutils literal notranslate"><span class="pre">ConstantSpeculativeExecutionPolicy</span></code> instance and reuses it (this also occurs if two sibling
profiles have the same configuration).</p>
<p>Each request uses its declared profile’s policy. If it doesn’t declare any profile, or if the
profile doesn’t have a dedicated policy, then the default profile’s policy is used.</p>
</section>
</section>

                
                    <div class="post-content"><div class="content-navigation">
    <div class="navigation navigation--prev">
        
            <a class="navigation__link" href="../shaded_jar/index.html">
                <button class="navigation__button">
                    <i class="scylla-icon scylla-icon--chevron-left"></i>
                </button>
                <div class="navigation__title">
                    <span class="colored">PREVIOUS</span> <br />Using the shaded JAR
                </div>
            </a>
        
    </div>
    <div class="navigation navigation--next">
        
            <a class="navigation__link" href="../ssl/index.html">
                <div class="navigation__title">
                    <span class="colored">NEXT</span> <br />SSL
                </div>
                <button class="navigation__button">
                    <i class="scylla-icon scylla-icon--chevron-right"></i>
                </button>
            </a>
        
    </div>
</div></div>
                
            </div>
            <div class="sidebar-left  large-order-1">
                
                    
                        <div id="side-nav" class="side-nav custom-scroll-bar" data-closable data-toggler=".show">
    <button class="collapsible-button">
        <i class="scylla-icon scylla-icon--chevron-left"></i>
    </button>
    <div class="side-nav-content">
        <div class="side-nav__search">
            <div class="search-box">
                <ci-search></ci-search>
            </div>
        </div>
        <div class="side-nav__versions">
    <ul class="dropdown menu scylla-dropdown scylla-dropdown--versions" data-dropdown-menu>
        <li class="scylla-dropdown__item">
            <a class="scylla-dropdown__title" href="#">
                
                    4.11.1.x
                
                <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
            </a>
            <ul class="menu scylla-dropdown__content">
                
                    
                        <li>
                            <a href="../../../../stable/index.html">4.13.0.x</a>
                        </li>
                    
                
                    
                        <li>
                            <a href="../../../../scylla-4.12.0.x/index.html">4.12.0.x</a>
                        </li>
                    
                
                    
                        <li>
                            <a href="index.html">4.11.1.x</a>
                        </li>
                    
                
                    
                        <li>
                            <a href="../../../../scylla-4.10.0.x/index.html">4.10.0.x</a>
                        </li>
                    
                
                    
                        <li>
                            <a href="../../../../scylla-4.7.2.x/index.html">4.7.2.x</a>
                        </li>
                    
                
                    
                        <li>
                            <a href="../../../../scylla-3.11.2.x/index.html">3.11.2.x</a>
                        </li>
                    
                
                    
                        <li>
                            <a href="../../../../scylla-3.11.0.x/index.html">3.11.0.x</a>
                        </li>
                    
                
                    
                        <li>
                            <a href="../../../../scylla-3.10.2.x/index.html">3.10.2.x</a>
                        </li>
                    
                
                    
                        <li>
                            <a href="../../../../scylla-3.7.2.x/index.html">3.7.2.x</a>
                        </li>
                    
                
                
            </ul>
        </li>
    </ul>
</div>
        <div class="side-nav__content">
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Java Driver for Scylla and Apache Cassandra®</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Documentation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../index.html">Manual</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../api_conventions/index.html">API conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../case_sensitivity/index.html">Case sensitivity</a></li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="../index.html">Core driver</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../address_resolution/index.html">Address resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../async/index.html">Asynchronous programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="../authentication/index.html">Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bom/index.html">Bill of Materials (BOM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../compression/index.html">Compression</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../configuration/index.html">Configuration</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l4"><a class="reference internal" href="../configuration/reference/README.html">Reference configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../control_connection/index.html">Control connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../custom_codecs/index.html">Custom codecs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../detachable_types/index.html">Detachable types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../idempotence/index.html">Query idempotence</a></li>
<li class="toctree-l3"><a class="reference internal" href="../integration/index.html">Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../load_balancing/index.html">Load balancing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../metadata/index.html">Metadata</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label for="toctree-checkbox-4"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l4"><a class="reference internal" href="../metadata/node/index.html">Node metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="../metadata/schema/index.html">Schema metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="../metadata/token/index.html">Token metadata</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../native_protocol/index.html">Native protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../non_blocking/index.html">Non-blocking programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="../paging/index.html">Paging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance/index.html">Performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pooling/index.html">Connection pooling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../query_timestamps/index.html">Query timestamps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reactive/index.html">Reactive Style Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reconnection/index.html">Reconnection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../request_tracker/index.html">Request tracker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../retries/index.html">Retries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../shaded_jar/index.html">Using the shaded JAR</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">Speculative query execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ssl/index.html">SSL</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../statements/index.html">Statements</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label for="toctree-checkbox-5"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l4"><a class="reference internal" href="../statements/batch/index.html">Batch statements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../statements/per_query_keyspace/index.html">Per-query keyspace</a></li>
<li class="toctree-l4"><a class="reference internal" href="../statements/prepared/index.html">Prepared statements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../statements/simple/index.html">Simple statements</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../temporal_types/index.html">Temporal types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../throttling/index.html">Request throttling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tracing/index.html">Query tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tuples/index.html">Tuples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../udts/index.html">User-defined types</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../developer/index.html">Developer docs</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label for="toctree-checkbox-6"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l3"><a class="reference internal" href="../../developer/admin/index.html">Administrative tasks</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../developer/common/index.html">Common infrastructure</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label for="toctree-checkbox-7"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l4"><a class="reference internal" href="../../developer/common/concurrency/index.html">Concurrency</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../developer/common/context/index.html">Driver context</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../developer/common/event_bus/index.html">Event bus</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../developer/native_protocol/index.html">Native protocol layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../developer/netty_pipeline/index.html">Netty pipeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../developer/request_execution/index.html">Request execution</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../mapper/index.html">Mapper</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label for="toctree-checkbox-8"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../mapper/config/index.html">Integration</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label for="toctree-checkbox-9"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/config/kotlin/index.html">Kotlin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/config/lombok/index.html">Lombok</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/config/record/index.html">Java 14 Records</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/config/scala/index.html">Scala</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../mapper/daos/index.html">DAOs</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label for="toctree-checkbox-10"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/custom_types/index.html">Custom result types</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/delete/index.html">Delete methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/getentity/index.html">GetEntity methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/increment/index.html">Increment methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/insert/index.html">Insert methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/null_saving/index.html">Null saving strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/query/index.html">Query methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/queryprovider/index.html">Query provider methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/select/index.html">Select methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/setentity/index.html">SetEntity methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/statement_attributes/index.html">Statement attributes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mapper/daos/update/index.html">Update methods</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../mapper/entities/index.html">Entities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mapper/mapper/index.html">Mapper interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../osgi/index.html">OSGi</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../query_builder/index.html">Query builder</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label for="toctree-checkbox-11"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l3"><a class="reference internal" href="../../query_builder/condition/index.html">Conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../query_builder/delete/index.html">DELETE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../query_builder/idempotence/index.html">Idempotence in the query builder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../query_builder/insert/index.html">INSERT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../query_builder/relation/index.html">Relations</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../query_builder/schema/index.html">Schema builder</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label for="toctree-checkbox-12"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l4"><a class="reference internal" href="../../query_builder/schema/aggregate/index.html">Aggregate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../query_builder/schema/function/index.html">Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../query_builder/schema/index/index.html">Index</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../query_builder/schema/keyspace/index.html">Keyspace</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../query_builder/schema/materialized_view/index.html">Materialized View</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../query_builder/schema/table/index.html">Table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../query_builder/schema/type/index.html">Type</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../query_builder/select/index.html">SELECT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../query_builder/term/index.html">Terms</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../query_builder/truncate/index.html">TRUNCATE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../query_builder/update/index.html">UPDATE</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../upgrade_guide/index.html">Upgrade guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog/index.html">Changelog</a></li>
</ul>

        </div>
    </div>
</div>
                    
                
            </div>
            
                <div class="sidebar-right large-order-3">
                    <div class="secondary-side-nav custom-scroll-bar">
    
    <ul class="contribute">
        <li class="contribute__item">
            <a href="https://github.com/scylladb/java-driver/issues/new?title=Issue in page Speculative query execution&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://java-driver.docs.scylladb.com/scylla-4.11.1.x/manual/core/speculative_execution/index%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix"
                target="_blank">
                <i class="icon fab fa-github" aria-hidden="true"></i>Create an issue
            </a>
        </li>
        
            <li class="contribute__item">
                
                
                    
                        
                    
                
                <a href="https://github.com/scylladb/java-driver/edit/scylla-4.11.1.x/docs/source/manual/core/speculative_execution/index.md"
                    target="_blank">
                    <i class="icon fa fa-edit" aria-hidden="true"></i>Edit this page
                </a>
            </li>
        
    </ul>

    
        <div class="secondary-side-nav__content">
            <p class="topic-title">On this page</p>
            <ul>
<li><a class="reference internal" href="#">Speculative query execution</a><ul>
<li><a class="reference internal" href="#quick-overview">Quick overview</a></li>
<li><a class="reference internal" href="#query-idempotence">Query idempotence</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#how-speculative-executions-affect-retries">How speculative executions affect retries</a></li>
<li><a class="reference internal" href="#tuning-and-practical-details">Tuning and practical details</a><ul>
<li><a class="reference internal" href="#stream-id-exhaustion">Stream id exhaustion</a></li>
<li><a class="reference internal" href="#request-ordering">Request ordering</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-multiple-policies">Using multiple policies</a></li>
</ul>
</li>
</ul>

        </div>
    
</div>
                </div>
            
        </section>

        <footer class="footer">
    <div class="footer-group">
        <div class="footer-top">
            <a class="footer-logo" href="https://www.scylladb.com">
                <img src="../../../_static/img/logo-scylla-horizontal-RGB.svg" alt="Logo" />
            </a>
            <div class="footer-links">
                <a class="footer-links__link" href="https://docs.scylladb.com/">Docs</a>
                <a class="footer-links__link" href="https://www.scylladb.com/company/contact-us/">Contact Us</a>
                <a class="footer-links__link" href="https://www.scylladb.com/company/">About Us</a>
            </div>
            <div class="footer-actions">
                <a class="footer-actions__link" href="https://groups.google.com/g/scylladb-users" target="_blank">
                    <span data-tooltip tabindex="1" title="User mailing list" data-position="bottom">
                        <img src="../../../_static/img/icons/icon-mail-list.svg" alt="Mail List Icon" />
                    </span>
                </a>
                <a class="footer-actions__link" href="http://slack.scylladb.com/" target="_blank">
                    <span data-tooltip tabindex="1" title="User Slack channel" data-position="bottom">
                        <img src="../../../_static/img/icons/icon-slack.svg" alt="Slack Icon" />
                    </span>
                </a>
            </div>
        </div>

        <div class="footer-bottom">
            
                <div class="footer-bottom__copyright">
                    
                        
                            &#169; 2022, ScyllaDB. All rights reserved.
                        
                    
                </div>
            
            
                <div class="footer-bottom__last-updated">
                    
                        Last updated on 25 May 2022.
                    
                </div>
            
            <div class="footer-bottom__version">
                Powered by
                <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a> &amp;
                <a href="https://sphinx-theme.scylladb.com/">ScyllaDB Theme 1.2.2</a>
            </div>
        </div>
    </div>
</footer>

        <noscript>
            <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP" height="0" width="0"
                style="display: none; visibility: hidden"></iframe>
        </noscript>
    </body>

</html>